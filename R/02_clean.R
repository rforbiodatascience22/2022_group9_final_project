# Load libraries ----------------------------------------------------------
library("tidyverse")
library("dplyr")
rm(list=ls())

# Define functions --------------------------------------------------------
source(file = "R/99_project_functions.R")


# Load data ---------------------------------------------------------------
patients  <- read_csv(file = "data/01_patients.csv")
proteomes <- read_csv(file = "data/01_proteomes.csv")


# Wrangle data ------------------------------------------------------------

# For patients: 
# Reduce meaningless variables
patients_clean <- patients %>% 
  select(-starts_with("Days"))

# For proteomes: 
# Create new column names
adjusted_names <- proteomes %>% 
  select(-c("RefSeq_accession_number","gene_symbol","gene_name")) %>% 
  colnames() %>% 
  map(change_format) %>% 
  unlist() %>% 
  unique()

# Wrangle proteomes
proteomes_clean <- proteomes %>% 
  select(-c("AO-A12D.05TCGA",
            "C8-A131.32TCGA",
            "AO-A12B.34TCGA")) %>%         # Remove duplicates
  rename_with(~ adjusted_names,
              .cols = -c(1:3)) %>%         # Rename protein columns
  select(-c("gene_symbol",
            "gene_name")) %>%              # Remove unnecessary descriptions
  mutate(frac_na = apply(.,
                         1,
                         count_na_func)/ncol(.)) %>% 
  filter(frac_na < 0.01) %>%               # Remove columns consisting of less than 99% of the data
  select(-c("frac_na")) %>% 
  pivot_longer(cols= -1,                            
               names_repair = "check_unique") %>% 
  pivot_wider(names_from = "RefSeq_accession_number",
              values_from = "value") %>%   # Transpose data frame
  rename("TCGA ID" = name)


# Merge data --------------------------------------------------------------
BC_data_clean <- inner_join(patients_clean,           
                            proteomes_clean,
                            by = c("Complete TCGA ID" = "TCGA ID"))


# Write data --------------------------------------------------------------
write_csv(x = patients_clean,
          file = "data/02_patients_clean.csv")
write_csv(x = proteomes_clean,
          file = "data/02_proteomes_clean.csv")
write_csv(x = BC_data_clean,
          file = "data/02_BC_data_clean.csv")
